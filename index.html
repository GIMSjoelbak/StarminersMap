<!DOCTYPE html>
<html lang ="en">
<head>
<meta http-equiv="Access-Control-Allow-Origin" content="*" />
  <base target="_top">
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
     integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
     crossorigin=""></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <style>
body {
      padding: 0;
      margin: 0;
    }
html, body, #map {
      height: 100%;
      width: 100%;
    }
/* Make the table cells have padding */
table {
  border-collapse: collapse;
  width: 100%;
}

td {
  padding: 3px;
font-size: 12px;
border: 1px solid black;
}

/* Set a fixed width for the table cells */
th, td {
  width: 20%;
  max-width: 250px;
}

/* Prevent text from wrapping */
td {
  white-space: nowrap;
  overflow: hidden;
}
td:last-child {
  width: 30%;
}
.leaflet-popup-content-wrapper {
  width: auto !important;
  max-width: 100% !important;
}
  </style>
  </head>
  <body>	  			
    <div id="map"</div>
	  <script src="coordinates.js"></script>
	  	  <script>
		  var polygon0 = L.polygon([[2180,5345],[2110,5495],[2300,5765],[2544,5765],[3100,5765],[3100,5190],[2800,5190],[2600,5235]],{fillColor: "#6495ed",fillOpacity: 0.5,originalOptions: {fillColor: "#6495ed",fillOpacity: 0.5}}).addTo(map);	  
fetch('./images/KaramjaTEST3.geojson')
    .then(response => response.json())
    .then(data => {
        var polygon1 = L.geoJSON(data, {
            fillColor: 'DarkGreen',
            fillOpacity: 0.5
        }).addTo(map);
    });
		  var polygon2 = L.polygon([[1582,4502],[1565,2965],[1420,2865],[1135,2838],[900,3065],[855,3280],[1107,4394],[1435,4550],[1550,4538]],{fillColor: "#bada55",fillOpacity: 0.5,originalOptions: {fillColor: "#bada55",fillOpacity: 0.5}}).addTo(map);
 polygon0.originalOptions = polygon0.options; // store original style options
			  polygon1.originalOptions = polygon1.options; // store original style options
polygon2.originalOptions = polygon2.options; // store original style options
function createPopup(polygon, location) {
  var table = document.createElement("table");
  var headerRow = table.insertRow();
  var header1 = headerRow.insertCell(0);
  var header2 = headerRow.insertCell(1);
  var header3 = headerRow.insertCell(2);
  var header4 = headerRow.insertCell(3);
  var header5 = headerRow.insertCell(4);
  var header6 = headerRow.insertCell(5);
  header1.innerHTML = "<b>Location</b>";
  header2.innerHTML = "<b>World</b>";
  header3.innerHTML = "<b>Min Time</b>";
  header4.innerHTML = "<b>Max Time</b>";
  header5.innerHTML = "<b>Time until</b>";	
  header6.innerHTML = "<b>Called Location</b>";

  // Keep track of the previous data
  var prevData = null;

  function updateTable() {
    fetch("stars.json?timestamp=" + Date.now())
      .then((response) => response.json())
      .then((data) => {
	    console.log(data); // log the retrieved data
        while (table.rows.length > 1) {
          table.deleteRow(-1);
        }

        var filteredData = data.filter((d) => d.location === location);

        // Compare the previous data with the new data
	var isDataChanged = false;
      if (prevData !== null) {
        var isDataChanged = JSON.stringify(filteredData) !== JSON.stringify(prevData);
      }
        prevData = filteredData;

        filteredData.forEach((d) => {
          var row = table.insertRow();
          var cell1 = row.insertCell(0);
          var cell2 = row.insertCell(1);
          var cell3 = row.insertCell(2);
          var cell4 = row.insertCell(3);
	  var cell5 = row.insertCell(4);
          var cell6 = row.insertCell(5);
		  var locationWord;
  if (d.location === 2) {
    locationWord = "Feldip/Isle of Souls";
  } else if (d.location === 1) {
    locationWord = "Karamja/Crandor";
} else if (d.location === 0) {
    locationWord = "Asgarnia";
  } else {
    locationWord = d.location;
  }
          cell1.innerHTML = locationWord;
          cell2.innerHTML = d.world;	
        // Convert Unix timestamp to normal time format
        var minTime = new Date(d.minTime * 1000).toLocaleString();
        var maxTime = new Date(d.maxTime * 1000).toLocaleString();
          cell3.innerHTML = minTime;
          cell4.innerHTML = maxTime;
	var now = Date.now();
        var relativeTime = Math.round((d.minTime * 1000 - now) / 60000);
        if (relativeTime > 0) {
          relativeTime = -relativeTime;
        }
          cell5.innerHTML = relativeTime + " min";
          cell6.innerHTML = d.calledLocation;
		    });


// Add flashing effect to the polygon if the data has changed
if (isDataChanged && prevData.length > 0) {
    if (polygon) {
        polygon.setStyle({ fillColor: "#ff0000", fillOpacity: 0.9 });
setTimeout(function () {
	 console.log("Changing back polygon style");
  polygon.setStyle({ fillColor: polygon.options.originalOptions.fillColor, fillOpacity: polygon.options.originalOptions.fillOpacity });
}, 500);
    }
}
  })
      .catch((error) => console.error(error));
  }

  updateTable();
  setInterval(updateTable, 60000);

  var popup = L.popup({ maxWidth: 700 }).setContent(table);
  polygon.bindPopup(popup);
}

// Add popup tables to each polygon
createPopup(polygon0, 0);
createPopup(polygon1, 1);
createPopup(polygon2, 2);
	  </script>
  </body>
 </html>
  
      
  
